#---------------------------------------------------------------
#
#     Spin-weighted angular momentum -- from 1511.05642
#
#---------------------------------------------------------------

def H(l, a, b, s):

    if l == 0 or abs(l) == 0.5:
        return 0.
    else:    
        return (l**2 - (a+b)**2/4.) * (l**2 - s**2) * (l**2 - (a-b)**2/4.) / (2. * (l - 0.5) * l**3 * (l + 0.5))

def h(l,m,s):
    return (l**2 - max(abs(m),abs(s))**2)*(l**2-(m*s/max(abs(m),abs(s)))**2)*(l**2-s**2)/(2*(l-0.5)*(l+0.5)*l**3)

# Coefficients for lambda_lms expansion 

def c0(l, m, s): return l*(l+1)

def c1(l, m, s):

    if l == 0:
        return 0.
    else:
        return -2. * m * s**2 /(l*(l + 1))

def c2(l, m, s):

    a = abs(m + s)
    b = abs(m - s)

    return H(l + 1, a, b, s) - H(l, a, b, s) - 1.

def c3(l, m, s): 

    a = abs(m + s)
    b = abs(m - s)

    if l == 0:
        return 0.
    elif l == 1:
        return -2. * s**2 * m * H(l+1., a, b, s)/(l * (l+1.)**2 * (l+2.))
    else :
        return -2. * s**2 * m * (H(l+1., a, b, s)/(l * (l+1.)**2 * (l+2.))
                               - H(l, a, b, s)/((l - 1.) * l**2 * (l+1.)))

def c4(l, m, s): 

    a = abs(m + s)
    b = abs(m - s)

    coe4 = 0.5 * H(l+1, a, b, s)**2/(l+1) - 0.25 * (l+2) * H(l+1, a, b, s) * H(l+2, a, b, s)/((l+1)*(l+3/2.))

    if l == 0:
        return coe4
    
    elif l == 1:
        return coe4 + (4. * s**4 * m**2 * (H(l+1, a, b, s)/(l**2 * (l+1)**4 * (l+2)**2))
                       + 0.5 * (H(l+1, a, b, s) * H(l, a, b, s)/(l*(l+1)) - H(l, a, b, s)**2/l)
                       + 0.25 * ((l-1)*H(l-1, a, b, s)*H(l, a, b, s)/((l - 0.5) * l)))
    
    elif l == 0.5:
        return coe4 + (4. * s**4 * m**2 * (H(l+1, a, b, s)/(l**2 * (l+1)**4 * (l+2)**2) - H(l, a, b, s)/((l-1)**2 * l**4 * (l+1)**2))
                       + 0.5 * (H(l+1, a, b, s) * H(l, a, b, s)/(l*(l+1)) - H(l, a, b, s)**2/l))
    
    else:
        return coe4 + (4. * s**4 * m**2 * (H(l+1, a, b, s)/(l**2 * (l+1)**4 * (l+2)**2) - H(l, a, b, s)/((l-1)**2 * l**4 * (l+1)**2))
                       + 0.5 * (H(l+1, a, b, s) * H(l, a, b, s)/(l*(l+1)) - H(l, a, b, s)**2/l)
                       + 0.25 * ((l-1)*H(l-1, a, b, s)*H(l, a, b, s)/((l - 0.5) * l)))


def c5(l, m, s):

    a = abs(m + s)
    b = abs(m - s)

    if l == 0:
        return 0.

    elif l == 1:
        return (-8.*s**6*m**3*H(l+1, a, b, s)/(l**3 * (l+1)**6 * (l+2)**3)
                + s**2*m*(-3*H(l+1, a, b, s)*H(l+1, a, b, s)/(l*(l+1)**3*(l+2))
                          +0.5*((3*l + 7)*H(l+1, a, b, s)*H(l+2, a, b, s)/(l*(l+1)**3*(l+3./2.)*(l+3)) 
                                -(3*l - 4)*H(l-1, a, b, s)*H(l, a, b, s)/((l-2)*(l-1/2)*l**3*(l+1))
                          )
                )
        )

    elif l == 0.5 or l == 2:
        return (8.*s**6*m**3*(H(l, a, b, s)/((l-1)**3 * l**6 * (l+1)**3) - H(l+1, a, b, s)/(l**3 * (l+1)**6 * (l+2)**3))
                + s**2*m*(3*H(l, a, b, s)*H(l, a, b, s)/((l-1)*l**3*(l+1))
                          -(7*l**2 + 7*l + 4)*H(l, a, b, s)*H(l+1, a, b, s)/((l-1)*l**3*(l+1)**3*(l+2))
                          -3*H(l+1, a, b, s)*H(l+1, a, b, s)/(l*(l+1)**3*(l+2))
                          +0.5*(3*l+7)*H(l+1, a, b, s)*H(l+2, a, b, s)/(l*(l+1)**3*(l+3/2)*(l+3))
                )
        )

    else:
        return (8.*s**6*m**3*(H(l, a, b, s)/((l-1)**3 * l**6 * (l+1)**3) - H(l+1, a, b, s)/(l**3 * (l+1)**6 * (l+2)**3))
                + s**2*m*(3*H(l, a, b, s)*H(l, a, b, s)/((l-1)*l**3*(l+1))
                          -(7*l**2 + 7*l + 4)*H(l, a, b, s)*H(l+1, a, b, s)/((l-1)*l**3*(l+1)**3*(l+2))
                          -3*H(l+1, a, b, s)*H(l+1, a, b, s)/(l*(l+1)**3*(l+2))
                          +0.5*((3*l+7)*H(l+1, a, b, s)*H(l+2, a, b, s)/(l*(l+1)**3*(l+3/2)*(l+3))
                                -(3*l-4)*H(l-1, a, b, s)*H(l, a, b, s)/((l-2)*(l-1/2)*l**3*(l+1))
                          )
                )
        )

def c6(l, m, s):

    a = abs(m + s)
    b = abs(m - s)

    if l == 0:
        return (0.25*(2.*H(l+1,a,b,s)**3/((l+1)**2)
                      +(l+2)**2*H(l+2,a,b,s)**2*H(l+1,a,b,s)/(4*(l+1)**2*(l+3/2)**2)
                      -(l+2)*(7*l + 10)*H(l+2,a,b,s)*H(l+1,a,b,s)**2/(4*(l+1)**2*(l+3/2)**2)
                      +(l+3)*H(l+1,a,b,s)*H(l+2,a,b,s)*H(l+3,a,b,s)/(12*(l+1)*(l+3/2)**2)
                )
                
        )

    elif l == 1:
        return (16.*s**8*m**4*H(l+1,a,b,s)/(l**4*(l+1)**8*(l+2)**4)
                + 4.*s**4*m**2*(3.*H(l+1,a,b,s)**2/(l**2*(l+1)**5*(l+2)**2)
                                -0.5*(3*l**2 + 14*l + 17)*H(l+1,a,b,s)*H(l+2,a,b,s)/(l**2*(l+1)**5*(l+3/2)*(l+2)*(l+3)**2)
                )
                +0.25*(2.*H(l+1,a,b,s)**3/((l+1)**2)
                       +(2*l**2 + 4*l + 3)*H(l,a,b,s)**2*H(l+1,a,b,s)/(l**2*(l+1)**2)
                       -(2*l**2 + 1)*H(l+1,a,b,s)**2*H(l,a,b,s)/(l**2*(l+1)**2)
                       - 2.*H(l,a,b,s)**3/(l**2)
                       +(l+2)*(3*l**2 + 2*l - 3)*H(l,a,b,s)*H(l+1,a,b,s)*H(l+2,a,b,s)/(4*l*(l+1)**2*(l+3/2)**2)
                       -(l-1)*(3*l**2 + 4*l - 2)*H(l+1,a,b,s)*H(l,a,b,s)*H(l-1,a,b,s)/(4*(l-1/2)**2*l**2*(l+1))
                       +(l+2)**2*H(l+2,a,b,s)**2*H(l+1,a,b,s)/(4*(l+1)**2*(l+3/2)**2)
                       -(l-1)**2*H(l-1,a,b,s)**2*H(l,a,b,s)/(4*(l-1/2)**2*l**2)
                       +(l-1)*(7*l - 3)*H(l-1,a,b,s)*H(l,a,b,s)**2/(4*(l-1/2)**2*l**2)
                       -(l+2)*(7*l + 10)*H(l+2,a,b,s)*H(l+1,a,b,s)**2/(4*(l+1)**2*(l+3/2)**2)
                       +(l+3)*H(l+1,a,b,s)*H(l+2,a,b,s)*H(l+3,a,b,s)/(12*(l+1)*(l+3/2)**2)
                       -(l-2)*H(l-2,a,b,s)*H(l-1,a,b,s)*H(l,a,b,s)/(12*(l-1/2)**2*l)
                )
                
        )

    elif l == 0.5:
        return (16.*s**8*m**4*(H(l+1,a,b,s)/(l**4*(l+1)**8*(l+2)**4)
                               - H(l,a,b,s)/((l-1)**4*l**8*(l+1)**4)
                )
                + 4.*s**4*m**2*(3.*H(l+1,a,b,s)**2/(l**2*(l+1)**5*(l+2)**2)
                                - 3.*H(l,a,b,s)**2/((l-1)**2*l**5*(l+1)**2)
                                +(11*l**4 + 22*l**3 + 31*l**2 + 20*l + 6)*H(l,a,b,s)*H(l+1,a,b,s)/((l-1)**2*l**5*(l+1)**5*(l+2)**2)
                                -0.5*(3*l**2 + 14*l + 17)*H(l+1,a,b,s)*H(l+2,a,b,s)/(l**2*(l+1)**5*(l+3/2)*(l+2)*(l+3)**2)
                )
                +0.25*(2.*H(l+1,a,b,s)**3/((l+1)**2)
                       +(2*l**2 + 4*l + 3)*H(l,a,b,s)**2*H(l+1,a,b,s)/(l**2*(l+1)**2)
                       -(2*l**2 + 1)*H(l+1,a,b,s)**2*H(l,a,b,s)/(l**2*(l+1)**2)
                       - 2.*H(l,a,b,s)**3/(l**2)
                       +(l+2)*(3*l**2 + 2*l - 3)*H(l,a,b,s)*H(l+1,a,b,s)*H(l+2,a,b,s)/(4*l*(l+1)**2*(l+3/2)**2)
                       +(l+2)**2*H(l+2,a,b,s)**2*H(l+1,a,b,s)/(4*(l+1)**2*(l+3/2)**2)
                       -(l+2)*(7*l + 10)*H(l+2,a,b,s)*H(l+1,a,b,s)**2/(4*(l+1)**2*(l+3/2)**2)
                       +(l+3)*H(l+1,a,b,s)*H(l+2,a,b,s)*H(l+3,a,b,s)/(12*(l+1)*(l+3/2)**2)
                )
                
        )

    elif l == 2:
        return (16.*s**8*m**4*(H(l+1,a,b,s)/(l**4*(l+1)**8*(l+2)**4)
                               - H(l,a,b,s)/((l-1)**4*l**8*(l+1)**4)
                )
                + 4.*s**4*m**2*(3.*H(l+1,a,b,s)**2/(l**2*(l+1)**5*(l+2)**2)
                                - 3.*H(l,a,b,s)**2/((l-1)**2*l**5*(l+1)**2)
                                +(11*l**4 + 22*l**3 + 31*l**2 + 20*l + 6)*H(l,a,b,s)*H(l+1,a,b,s)/((l-1)**2*l**5*(l+1)**5*(l+2)**2)
                                -0.5*(3*l**2 + 14*l + 17)*H(l+1,a,b,s)*H(l+2,a,b,s)/(l**2*(l+1)**5*(l+3/2)*(l+2)*(l+3)**2)
                                
                )
                +0.25*(2.*H(l+1,a,b,s)**3/((l+1)**2)
                       +(2*l**2 + 4*l + 3)*H(l,a,b,s)**2*H(l+1,a,b,s)/(l**2*(l+1)**2)
                       -(2*l**2 + 1)*H(l+1,a,b,s)**2*H(l,a,b,s)/(l**2*(l+1)**2)
                       - 2.*H(l,a,b,s)**3/(l**2)
                       +(l+2)*(3*l**2 + 2*l - 3)*H(l,a,b,s)*H(l+1,a,b,s)*H(l+2,a,b,s)/(4*l*(l+1)**2*(l+3/2)**2)
                       -(l-1)*(3*l**2 + 4*l - 2)*H(l+1,a,b,s)*H(l,a,b,s)*H(l-1,a,b,s)/(4*(l-1/2)**2*l**2*(l+1))
                       +(l+2)**2*H(l+2,a,b,s)**2*H(l+1,a,b,s)/(4*(l+1)**2*(l+3/2)**2)
                       -(l-1)**2*H(l-1,a,b,s)**2*H(l,a,b,s)/(4*(l-1/2)**2*l**2)
                       +(l-1)*(7*l - 3)*H(l-1,a,b,s)*H(l,a,b,s)**2/(4*(l-1/2)**2*l**2)
                       -(l+2)*(7*l + 10)*H(l+2,a,b,s)*H(l+1,a,b,s)**2/(4*(l+1)**2*(l+3/2)**2)
                       +(l+3)*H(l+1,a,b,s)*H(l+2,a,b,s)*H(l+3,a,b,s)/(12*(l+1)*(l+3/2)**2)
                       -(l-2)*H(l-2,a,b,s)*H(l-1,a,b,s)*H(l,a,b,s)/(12*(l-1/2)**2*l)
                )
                
        )

    else:
        return (16.*s**8*m**4*(H(l+1,a,b,s)/(l**4*(l+1)**8*(l+2)**4)
                               - H(l,a,b,s)/((l-1)**4*l**8*(l+1)**4)
                )
                + 4.*s**4*m**2*(3.*H(l+1,a,b,s)**2/(l**2*(l+1)**5*(l+2)**2)
                                - 3.*H(l,a,b,s)**2/((l-1)**2*l**5*(l+1)**2)
                                +(11*l**4 + 22*l**3 + 31*l**2 + 20*l + 6)*H(l,a,b,s)*H(l+1,a,b,s)/((l-1)**2*l**5*(l+1)**5*(l+2)**2)
                                +0.5*((3*l**2 - 8*l + 6)*H(l-1,a,b,s)*H(l,a,b,s)/((l-2)**2*(l-1)*(l-1/2)*l**5*(l+1)**2)
                                      -(3*l**2 + 14*l + 17)*H(l+1,a,b,s)*H(l+2,a,b,s)/(l**2*(l+1)**5*(l+3/2)*(l+2)*(l+3)**2)
                                )
                )
                +0.25*(2.*H(l+1,a,b,s)**3/((l+1)**2)
                       +(2*l**2 + 4*l + 3)*H(l,a,b,s)**2*H(l+1,a,b,s)/(l**2*(l+1)**2)
                       -(2*l**2 + 1)*H(l+1,a,b,s)**2*H(l,a,b,s)/(l**2*(l+1)**2)
                       - 2.*H(l,a,b,s)**3/(l**2)
                       +(l+2)*(3*l**2 + 2*l - 3)*H(l,a,b,s)*H(l+1,a,b,s)*H(l+2,a,b,s)/(4*l*(l+1)**2*(l+3/2)**2)
                       -(l-1)*(3*l**2 + 4*l - 2)*H(l+1,a,b,s)*H(l,a,b,s)*H(l-1,a,b,s)/(4*(l-1/2)**2*l**2*(l+1))
                       +(l+2)**2*H(l+2,a,b,s)**2*H(l+1,a,b,s)/(4*(l+1)**2*(l+3/2)**2)
                       -(l-1)**2*H(l-1,a,b,s)**2*H(l,a,b,s)/(4*(l-1/2)**2*l**2)
                       +(l-1)*(7*l - 3)*H(l-1,a,b,s)*H(l,a,b,s)**2/(4*(l-1/2)**2*l**2)
                       -(l+2)*(7*l + 10)*H(l+2,a,b,s)*H(l+1,a,b,s)**2/(4*(l+1)**2*(l+3/2)**2)
                       +(l+3)*H(l+1,a,b,s)*H(l+2,a,b,s)*H(l+3,a,b,s)/(12*(l+1)*(l+3/2)**2)
                       -(l-2)*H(l-2,a,b,s)*H(l-1,a,b,s)*H(l,a,b,s)/(12*(l-1/2)**2*l)
                )
                
        )

class lambdalms:

    def __init__(self, l, m, s, g):

         self.l = l
         self.m = m
         self.s = s
         self.g = g

    def llms(self):

        if self.g == 0:
            return c0(self.l,self.m,self.s) - self.s*(self.s + 1)
        else:
            if self.s <= abs(1):
                return (c0(self.l,self.m,self.s)
                        + c1(self.l,self.m,self.s)*self.g
                        + c2(self.l,self.m,self.s)*self.g**2
                        + c3(self.l,self.m,self.s)*self.g**3
                        + c4(self.l,self.m,self.s)*self.g**4
                        + c5(self.l,self.m,self.s)*self.g**5)
            else:
                return (c0(self.l,self.m,self.s)
                        + c1(self.l,self.m,self.s)*self.g
                        + c2(self.l,self.m,self.s)*self.g**2
                        + c3(self.l,self.m,self.s)*self.g**3)
                    
